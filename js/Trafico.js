var listaVehiculos = new Array({
    tipo: '2D',
    descripcion: 'Camión de 2 ejes pequeños',
    img: '2D.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: null,
    eje4: null,
    peso1: 6.6138,
    peso2: 8.8184,
    peso3: null,
    peso4: null
}, {
    tipo: '2DA',
    descripcion: 'Camión de 2 ejes medianos',
    img: '2DA.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: null,
    eje4: null,
    peso1: 6.6138,
    peso2: 15.4322,
    peso3: null,
    peso4: null
}, {
    tipo: '2DB',
    descripcion: 'Camión de 2 ejes grandes',
    img: '2DB.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: null,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: null,
    peso4: null
}, {
    tipo: '3-A',
    descripcion: 'Camión de 3 ejes',
    img: '3-A.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: null,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: null,
    peso4: null
}, {
    tipo: '4-C',
    descripcion: 'Camión de 4 ejes',
    img: '4-C.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 3,
    eje3: null,
    eje4: null,
    peso1: 15.4322,
    peso2: 52.9104,
    peso3: null,
    peso4: null
}, {
    tipo: '4-D',
    descripcion: 'Camión con tamdem y direccional y tamdem posterior',
    img: '4-D.PNG',
    porcentaje: null,
    checked: false,
    eje1: 2,
    eje2: 2,
    eje3: null,
    eje4: null,
    peso1: 26.4552,
    peso2: 44.092,
    peso3: null,
    peso4: null
}, {
    tipo: 'V2DB',
    descripcion: 'Volqueta de dos ejes 8 m3',
    img: 'V2DB.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: null,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: null,
    peso4: null
}, {
    tipo: 'V3A',
    descripcion: 'Volqueta de tres ejes 10-14 m3',
    img: 'V3A.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: null,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: null,
    peso4: null
}, {
    tipo: 'VZS',
    descripcion: 'Volqueta ZS de tres ejes 16 m3',
    img: 'VZS.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: null,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: null,
    peso4: null
}, {
    tipo: 'T2',
    descripcion: 'Tracto camión de dos ejes',
    img: 'T2.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: null,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: null,
    peso4: null
}, {
    tipo: 'T3',
    descripcion: 'Tracto camión de tres ejes',
    img: 'T3.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: null,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: null,
    peso4: null
}, {
    tipo: '2S1',
    descripcion: 'Tracto camión de 2 ejes y semiremolque de 1 eje',
    img: '2S1.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: 1,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: 24.2506,
    peso4: null
}, {
    tipo: '2S2',
    descripcion: 'Tracto camión de 2 ejes y semiremolque de 2 ejes',
    img: '2S2.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: 2,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: 44.092,
    peso4: null
}, {
    tipo: '2S3',
    descripcion: 'Tracto camión de 2 ejes y semiremolque de 3 ejes',
    img: '2S3.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: 3,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: 52.9104,
    peso4: null
}, {
    tipo: '3S1',
    descripcion: 'Tracto camión de 3 ejes y semiremolque de 1 eje',
    img: '3S1.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: 1,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: 24.2506,
    peso4: null
}, {
    tipo: '3S2',
    descripcion: 'Tracto camión de 3 ejes y semiremolque de 2 ejes',
    img: '3S2.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: 2,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: 44.092,
    peso4: null
}, {
    tipo: '3S3',
    descripcion: 'Tracto camión de 3 ejes y semiremolque de 3 ejes',
    img: '3S3.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: 3,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: 52.9104,
    peso4: null
}, {
    tipo: '2R2',
    descripcion: 'Camión remolcador de 2 ejes y remolque de 2 ejes',
    img: '2R2.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: 1,
    eje4: 1,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: 24.2506,
    peso4: 24.2506
}, {
    tipo: '2R3',
    descripcion: 'Camión remolcador de 2 ejes y remolque de 3 ejes',
    img: '2R3.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: 1,
    eje4: 2,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: 24.2506,
    peso4: 44.092
}, {
    tipo: '3R2',
    descripcion: 'Camión remolcador de 3 ejes y remolque de 2 ejes',
    img: '3R2.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: 1,
    eje4: 1,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: 24.2506,
    peso4: 24.2506
}, {
    tipo: '3R3',
    descripcion: 'Camión remolcador de 3 ejes y remolque de 3 ejes',
    img: '3R3.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: 1,
    eje4: 2,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: 24.2506,
    peso4: 44.092
}, {
    tipo: '2B1',
    descripcion: 'Camión remolcador de 2 ejes y remolque balanceado de 1 eje',
    img: '2B1.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: 1,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: 24.2506,
    peso4: null
}, {
    tipo: '2B2',
    descripcion: 'Camión remolcador de 2 ejes y remolque balanceado de 2 ejes',
    img: '2B2.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: 2,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: 44.092,
    peso4: null
}, {
    tipo: '2B3',
    descripcion: 'Camión remolcador de 2 ejes y remolque balanceado de 3 ejes',
    img: '2B3.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 1,
    eje3: 3,
    eje4: null,
    peso1: 15.4322,
    peso2: 24.2506,
    peso3: 52.9104,
    peso4: null
}, {
    tipo: '3B1',
    descripcion: 'Camión remolcador de 3 ejes y remolque balanceado de 1 eje',
    img: '3B1.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: 1,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: 24.2506,
    peso4: null
}, {
    tipo: '3B2',
    descripcion: 'Camión remolcador de 3 ejes y remolque balanceado de 2 ejes',
    img: '3B2.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: 2,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: 44.092,
    peso4: null
}, {
    tipo: '3B3',
    descripcion: 'Camión remolcador de 3 ejes y remolque balanceado de 3 ejes',
    img: '3B3.PNG',
    porcentaje: null,
    checked: false,
    eje1: 1,
    eje2: 2,
    eje3: 3,
    eje4: null,
    peso1: 15.4322,
    peso2: 44.092,
    peso3: 52.9104,
    peso4: null
}, );

$(function () {
    $('#frmTraficoEq').validate();

    var clasfvehiculosBody = $('#clasfvehiculos tbody');

    //Cargar vehiculos en la vista
    $(listaVehiculos).each(function (i, item) {

        var tr = '<tr index="' + i + '">';
        tr += '<td width="30px"><input index="' + i + '" class="form-control form-control-sm vehiculo-checkbox" type="checkbox" value="' + item.tipo + '"/></td>';
        tr += '<td width="40px"><label>' + item.tipo + '</label></td>';
        tr += '<td width="130px"><img src="Images/FlotaVehiculos/' + item.img + '" width="120px" height="35px"/></td>';
        tr += '<td width="160px"><label>' + item.descripcion + '</label></td>';
        tr += '<td width="30px" height="40px"><input style="font-size:11.5px" class="vehiculo-porcentaje" type="text" value="' + (item.porcentaje ? item.porcentaje : '') + '"/></td>';
        tr += '<td width="30px" height="40px"><input style="font-size:11px" class="trafico-peso-rigid"   id="peso1_' + i + '"   type="text" value="' + (item.peso1 ? item.peso1 : '') + '" /></td>';
        tr += '<td width="30px" height="40px"><input style="font-size:11px" class="trafico-peso-rigid"   id="peso2_' + i + '"   type="text" value="' + (item.peso2 ? item.peso2 : '') + '" /></td>';
        tr += '<td width="30px" height="40px"><input style="font-size:11px" class="trafico-peso-rigid"   id="peso3_' + i + '"   type="text" value="' + (item.peso3 ? item.peso3 : '') + '" /></td>';
        tr += '<td width="30px" height="40px"><input style="font-size:11px" class="trafico-peso-rigid"  id="peso4_' + i + '"   type="text" value="' + (item.peso4 ? item.peso4 : '') + '" /></td>';
        tr += '<td width="30px" height="40px" style="display:none"><input  type="text" value="' + (item.orden ? item.orden : '') + '" /></td>';
        tr += '</tr>';

        $(clasfvehiculosBody).append(tr);

        var peso1 = $('#peso1_' + i + '').val();
        if (peso1 == "") {
            $('#peso1_' + i + '').prop("disabled", true);
        } else {
            $('#peso1_' + i + '').prop("disabled", false);
        }
        var peso2 = $('#peso2_' + i + '').val();
        if (peso2 == "") {
            $('#peso2_' + i + '').prop("disabled", true);
        } else {
            $('#peso2_' + i + '').prop("disabled", false);
        }
        var peso3 = $('#peso3_' + i + '').val();
        if (peso3 == "") {
            $('#peso3_' + i + '').prop("disabled", true);
        } else {
            $('#peso3_' + i + '').prop("disabled", false);
        }
        var peso4 = $('#peso4_' + i + '').val();
        if (peso4 == "") {
            $('#peso4_' + i + '').prop("disabled", true);
        } else {
            $('#peso4_' + i + '').prop("disabled", false);
        }


    });
    $('.vehiculo-porcentaje').autoNumeric({
        aSep: '',
        aDec: '.',
        mDec: 2
    });

    //Abrir modal de vehiculos (Cargar vehiculos)
    $('#abrir-modal-vehiculos').click(function () {
        var v = $('#pavimentoRigido').valid();
        if (v) {
            $('#myModalvehiculos').modal('show');
        }
    });

    //Botón cargar vehiculos del modal
    $('#cargar-vehiculos').click(function () {

        //1. Validar
        var ptotal = 0;
        var valid = $('#frmTraficoEq').valid();
        $('#clasfvehiculos tbody tr').each(function (i, tr) {
            var chk = $(tr).find('.vehiculo-checkbox').prop('checked');
            var por = $(tr).find('.vehiculo-porcentaje').autoNumeric('get') * 1;

            if (chk) {
                if (por > 0) {
                    ptotal += por;
                } else {
                    valid = false;
                }
            }
        });
        if (ptotal > 100) valid = false;
        if (!valid) alert('Ingrese un porcentaje correcto para todos los items seleccionados.\nPorcentaje total: ' + ptotal);

        //2. Asignar checked y porcentaje
        if (valid) {
            $('#clasfvehiculos tbody tr').each(function (i, tr) {
                var chk = $(tr).find('.vehiculo-checkbox').prop('checked');
                var index = $(tr).find('.vehiculo-checkbox').attr('index');
               
                var por = $(tr).find('.vehiculo-porcentaje').autoNumeric('get') * 1;
                var item = listaVehiculos[i];

                if (chk) {
                    item.checked = true;
                    item.porcentaje = por;
                    item.orden = index;

                } else {
                    item.checked = false;
                    item.porcentaje = 0;
                    item.orden = index;
                }

            });
            $('#myModalvehiculos').modal('hide');
        }

        //3. Calcular tráfico
        CalcularTrafico();

        //4. Cargar tabla
        CargarTablaTrafico();
    });

    //Checkbox de seleccion vehiculo
    $(".vehiculo-checkbox").change(function () {
        var tr = $(this).parents('tr');
        var chk = $(this).prop('checked');
        $(tr).find('.vehiculo-porcentaje').toggle();
        $(tr).find('.trafico-peso-rigid').toggle();

    });

    $(document).on('click', '.item-trafico', function () {
        var index = $(this).attr('index');
        var eje = $(this).attr('eje');
        var item = listaVehiculos[index];
        var data = item['data' + eje];
        var pt_rigido = $('#trf_pt').val() * 1;
        var tiposEjes_rigido = $(this).attr('tiposEjes');

        if (tiposEjes_rigido == 1) {
            var title = 'Factores de equivalencia de carga de eje para pavimentos flexibles, eje simple' + " y pt = " + pt_rigido + ". Para un vehículo tipo " + item.tipo + ', eje ' + eje;
        } else if (tiposEjes_rigido == 2) {
            var title = 'Factores de equivalencia de carga de eje para pavimentos flexibles, eje tándem' + " y pt = " + pt_rigido + ". Para un vehículo tipo " + item.tipo + ', eje ' + eje;
        } else if (tiposEjes_rigido == 3) {
            var title = 'Factores de equivalencia de carga de eje para pavimentos flexibles, eje triple' + " y pt = " + pt_rigido + ". Para un vehículo tipo " + item.tipo + ', eje ' + eje;
        }

        $('#resultadoequivalencia').show();
        $('#resultadoequivalencia').html('');
        CargarTablaEquivalencia('#resultadoequivalencia', data, title);
    });

    $('#trf_tmda, #trf_tasa_cre, #trf_per_dis, #trf_direccionalidad, #trf_pt, #trf_espesor').change(function () {
        CalcularTrafico();
        CargarTablaTrafico();
    });
});

function CalcularTrafico() {
    var pt = $('#trf_pt').val() * 1;
    var espesor = $('#trf_espesor').val() * 1;

    $(listaVehiculos).each(function (i, item) {
        CalcularTraficoItem(item, pt, espesor);
    });
}

function CalcularTraficoItem(item, pt, espesor) {
    if (item.checked) {


        item.peso1 = $('#peso1_' + item.orden + '').val();
        item.peso2 = $('#peso2_' + item.orden + '').val();

        item.peso3 = $('#peso3_' + item.orden + '').val();
        item.peso4 = $('#peso4_' + item.orden + '').val();
        
        item.data1 = ObtenerInterpolacion(pt, item.eje1, item.peso1, espesor);
        item.int1 = item.data1.value;

        item.data2 = ObtenerInterpolacion(pt, item.eje2, item.peso2, espesor);
        item.int2 = item.data2.value;

        item.data3 = ObtenerInterpolacion(pt, item.eje3, item.peso3, espesor);
        item.int3 = item.data3.value;

        item.data4 = ObtenerInterpolacion(pt, item.eje4, item.peso4, espesor);
        item.int4 = item.data4.value;

        console.log('pt: ' + pt + ', eje1: ' + item.eje1 + ', peso1: ' + item.peso1 + ', espesor: ' + espesor + ', int1: ' + item.int1);
        console.log('pt: ' + pt + ', eje2: ' + item.eje2 + ', peso2: ' + item.peso2 + ', espesor: ' + espesor + ', int2: ' + item.int2);
        console.log('pt: ' + pt + ', eje3: ' + item.eje3 + ', peso3: ' + item.peso3 + ', espesor: ' + espesor + ', int3: ' + item.int3);
        console.log('pt: ' + pt + ', eje4: ' + item.eje4 + ', peso4: ' + item.peso4 + ', espesor: ' + espesor + ', int4: ' + item.int4);

        item.factorCamion = item.int1 + item.int2 + item.int3 + item.int4;
        item.esal = CalcularEsal(item);

        console.log('esal', item.esal);
    } else {
        item.data1 = null;
        item.int1 = 0;

        item.data2 = null;
        item.int2 = 0;

        item.data3 = null;
        item.int3 = 0;

        item.data4 = null;
        item.int4 = 0;

        item.factorCamion = 0;
        item.esal = 0;
    }
}

function CalcularFactorCrecimiento() {
    var r = $('#trf_tasa_cre').val() * 1 / 100;
    var d = $('#trf_per_dis').val() * 1;
    var factorCrecimiento = (Math.pow(1 + r, d) - 1) / Math.log(1 + r);
    return isNaN(factorCrecimiento) ? 0 : factorCrecimiento;
};

function CalcularEsal(item) {
    var tmda = $('#trf_tmda').val() * 1;
    var porc = item.porcentaje / 100;
    var dire = $('#trf_direccionalidad').val() * 1 / 100;
    var fcre = CalcularFactorCrecimiento();
    var fcam = item.factorCamion;
    var esal = tmda * porc * dire * 365 * fcre * fcam;

    return esal;
};

function CargarTablaTrafico() {
    var tbodyesalsa = $('#esalsTabla tbody');
    var total = 0;
    $(tbodyesalsa).html('');

    $(listaVehiculos).each(function (i, item) {
        if (item.checked) {

            item.peso1 = $('#peso1_' + item.orden + '').val();
            item.peso2 = $('#peso2_' + item.orden + '').val();

            item.peso3 = $('#peso3_' + item.orden + '').val();
            item.peso4 = $('#peso4_' + item.orden + '').val();

            var tr = '<tr>';
            tr += '<td>' + item.tipo + '</td>';
            tr += '<td>' + (item.eje1 ? item.eje1 : '') + '</td>';
            tr += '<td>' + (item.eje2 ? item.eje2 : '') + '</td>';
            tr += '<td>' + (item.eje3 ? item.eje3 : '') + '</td>';
            tr += '<td>' + (item.eje4 ? item.eje4 : '') + '</td>';
            tr += '<td>' + (item.peso1 ? item.peso1 : '') + '</td>';
            tr += '<td>' + (item.peso2 ? item.peso2 : '') + '</td>';
            tr += '<td>' + (item.peso3 ? item.peso3 : '') + '</td>';
            tr += '<td>' + (item.peso4 ? item.peso4 : '') + '</td>';
            tr += '<td>' + item.porcentaje + '</td>';
            tr += '<td><a href="javascript:void(0);" index="' + i + '" class="item-trafico" eje="1" value="' + item.int1.toFixed(4) + '" tiposEjes="' + item.eje1 + '">' + item.int1.toFixed(4) + '</a></td>';
            tr += '<td><a href="javascript:void(0);" index="' + i + '" class="item-trafico" eje="2" value="' + item.int2.toFixed(4) + '" tiposEjes="' + item.eje2 + '">' + item.int2.toFixed(4) + '</a></td>';
            tr += '<td><a href="javascript:void(0);" index="' + i + '" class="item-trafico" eje="3" value="' + item.int3.toFixed(4) + '" tiposEjes="' + item.eje3 + '">' + item.int3.toFixed(4) + '</a></td>';
            tr += '<td><a href="javascript:void(0);" index="' + i + '" class="item-trafico" eje="4" value="' + item.int4.toFixed(4) + '" tiposEjes="' + item.eje4 + '">' + item.int4.toFixed(4) + '</a></td>';
            tr += '<td>' + item.factorCamion.toFixed(3) + '</td>';
            tr += '<td>' + item.esal.toFixed(2) + '</td>';
            tr += '</tr>';

            total += item.esal;

            $(tbodyesalsa).append(tr);
        }
    });
    $("#noCalcula_ESALS").hide();
    $('.numeroejesequi').val(total.toFixed(0));
    document.getElementById("suma_esals_rigid").innerHTML = total.toFixed(0);
    $('#resultadoequivalencia').hide();
};

function CargarTablaEquivalencia(div, data, title) {
    var tabla = $('<table id="tablaEquivalencia" width="100%" class="table table-bordered" border="1" cellspacing=0> \
    <thead>\
        <tr>\
            <th class="text-center" colspan="10">' + title + '</th>\
        </tr>\
        <tr>\
            <th>Kips</th>\
            <th>6 in</th>\
            <th>7 in</th>\
            <th>8 in</th>\
            <th>9 in</th>\
            <th>10 in</th>\
            <th>11 in</th>\
            <th>12 in</th>\
            <th>13 in</th>\
            <th>14 in</th>\
        </tr>\
    </thead>\
    <tbody>\
    </tbody>\
</table>');

    $(div).append(tabla);
    var tbody = $(tabla).find('tbody');

    if (data.tabla != null) {
        $(data.tabla).each(function (i, dfila) {
            var tr = '<tr class="' + (data.finf == i || data.fsup == i ? 'info' : '') + '">'
            $(dfila).each(function (j, dcol) {
                tr += '<td class="' + (data.cesp == j ? 'info' : '') + '">' + dcol + '</td>';
            })
            tr += '</tr>';
            $(tbody).append(tr);
            if (($(tabla).find("tr").hasClass("info")) || ($(tabla).find('td').hasClass("info"))) {
                $(tabla).find('tr.info').css('background-color', "#c0e4fc");
                $(tabla).find('td.info').css('background-color', "#c0e4fc");
                $(tabla).find('tr.info td.info').css('background-color', "#008ED1");
                $(tabla).find('tr.info td.info').css('color', "#FFFFFF");
            }
        });
        $(div).append('<br> <p style="text-align:justify">' + data.descript + '</p>');
        $(div).append(data.formula + '<br>');
        $(div).append(data.formulaVar + '<br><br><br>');
        $(div).css("text-align", "center");
        $(div).css('color', "black");

    }
}